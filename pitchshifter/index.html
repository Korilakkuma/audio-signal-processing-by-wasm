<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pitch Shifter &amp; Whammy | Audio Signal Processing by WebAssembly</title>
    <link rel="stylesheet" href="../app.css" />
  </head>
  <body>
    <section>
      <nav><a href="../">TOP</a> &gt; &gt; Pitch Shifter</nav>
      <dt>
        <dt><label for="file-uploader">Upload Audio File</label></dt>
        <dd><input type="file" id="file-uploader" /></dd>
        <dt><label for="checkbox-whammy">Whammy</label></dt>
        <dd><input type="checkbox" id="checkbox-whammy" /></dd>
        <dt><label for="range-pitch">Pitch: <span id="output-pitch">1</span></label></dt>
        <dd><input type="range" id="range-pitch" value="1" min="0.5" max="4" step="0.05" /></dd>
      </dt>
    </section>
    <script>
      const numberOfChannels = 2;

      let audio = null;
      let pitch = 1;
      let whammyTimer = null;

      WebAssembly
        .instantiateStreaming(fetch('./pitchshifter.wasm'))
        .then(({ instance }) => {
          const audiocontext = new AudioContext();
          const processor    = audiocontext.createScriptProcessor(0, numberOfChannels, numberOfChannels);

          document.getElementById('file-uploader').addEventListener('change', async (event) => {
            processor.onaudioprocess = null;
            processor.disconnect(0);

            if (audio) {
              audio.pause();
            }

            try {
              await audiocontext.resume();

              const objectURL = window.URL.createObjectURL(event.target.files[0]);

              audio = new Audio(objectURL);

              const source = audiocontext.createMediaElementSource(audio);

              source.connect(processor);
              processor.connect(audiocontext.destination);

              const bufferSize = processor.bufferSize;

              const linearMemory = instance.exports.memory.buffer;

              processor.onaudioprocess = (event) => {
                const inputLs  = event.inputBuffer.getChannelData(0);
                const inputRs  = event.inputBuffer.getChannelData(1);
                const outputLs = event.outputBuffer.getChannelData(0);
                const outputRs = event.outputBuffer.getChannelData(1);

                const inputOffsetL = instance.exports.alloc_memory_inputLs(bufferSize);
                const inputOffsetR = instance.exports.alloc_memory_inputRs(bufferSize);

                const inputLinearMemoryLs = new Float32Array(linearMemory, inputOffsetL, bufferSize);
                const inputLinearMemoryRs = new Float32Array(linearMemory, inputOffsetR, bufferSize);

                inputLinearMemoryLs.set(inputLs);
                inputLinearMemoryRs.set(inputRs);

                const outputOffsetL = instance.exports.pitchshifterL(pitch, bufferSize);
                const outputOffsetR = instance.exports.pitchshifterR(pitch, bufferSize);

                outputLs.set(new Float32Array(linearMemory, outputOffsetL, bufferSize));
                outputRs.set(new Float32Array(linearMemory, outputOffsetR, bufferSize));
              };

              audio.play();
            } catch (e) {
              console.error(e);
            }
          }, false);

          document.getElementById('range-pitch').addEventListener('input', (event) => {
            const range = event.currentTarget;

            pitch = range.valueAsNumber;

            document.getElementById('output-pitch').textContent = range.value;
          }, false);

          document.getElementById('checkbox-whammy').addEventListener('click', (event) => {
            const checkbox = event.currentTarget;

            if (checkbox.checked) {
              const diff = 3 - pitch;
              const rate = diff / 50;

              whammyTimer = window.setInterval(() => {
                pitch += rate;

                document.getElementById('range-pitch').valueAsNumber = pitch;
                document.getElementById('output-pitch').textContent = Math.floor(pitch * 100) / 100;

                if (pitch >= 3) {
                  window.clearInterval(whammyTimer);
                  whammyTimer = null;
                }
              }, 50);
            } else {
              window.clearInterval(whammyTimer);
              whammyTimer = null;
            }
          }, false);
        })
        .catch(console.error);
    </script>
  </body>
</html>
