<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Noise | Audio Signal Processing by WebAssembly</title>
    <link rel="stylesheet" href="../app.css" />
  </head>
  <body>
    <section>
      <nav><a href="../">TOP</a> &gt;&gt; Noise</nav>
      <div>
        <select id="select-noise">
          <option value="" selected>SELECT NOISE</option>
          <option value="whitenoise">White Noise</option>
          <option value="pinknoise">Pink Noise</option>
          <option value="browniannoise">Brownian Noise</option>
        </select>
      </div>
    </section>
    <script>
      const numberOfChannels = 2;

      let type = '';

      WebAssembly
        .instantiateStreaming(fetch('./noise.wasm'))
        .then(async ({ instance }) => {
          const audiocontext = new AudioContext();
          const processor    = audiocontext.createScriptProcessor(0, numberOfChannels, numberOfChannels);

          processor.connect(audiocontext.destination);

          const bufferSize = processor.bufferSize;

          const linearMemory = instance.exports.memory.buffer;

          processor.onaudioprocess = (event) => {
            const outputLs = event.outputBuffer.getChannelData(0);
            const outputRs = event.outputBuffer.getChannelData(1);

            switch (type) {
              case 'whitenoise': {
                const offsetInputL = instance.exports.whitenoiseL(Date.now(), bufferSize);
                const offsetInputR = instance.exports.whitenoiseR(Date.now(), bufferSize);

                outputLs.set(new Float32Array(linearMemory, offsetInputL, bufferSize));
                outputRs.set(new Float32Array(linearMemory, offsetInputR, bufferSize));

                break;
              }

              case 'pinknoise': {
                const offsetInputL = instance.exports.pinknoiseL(Date.now(), bufferSize);
                const offsetInputR = instance.exports.pinknoiseR(Date.now(), bufferSize);

                outputLs.set(new Float32Array(linearMemory, offsetInputL, bufferSize));
                outputRs.set(new Float32Array(linearMemory, offsetInputR, bufferSize));

                break;
              }

              case 'browniannoise': {
                const offsetInputL = instance.exports.browniannoiseL(Date.now(), bufferSize);
                const offsetInputR = instance.exports.browniannoiseR(Date.now(), bufferSize);

                outputLs.set(new Float32Array(linearMemory, offsetInputL, bufferSize));
                outputRs.set(new Float32Array(linearMemory, offsetInputR, bufferSize));

                break;
              }
            }
          };

          const releaseAutoplayPolicy = async () => {
            await audiocontext.resume();

            document.getElementById('select-noise').addEventListener('change', (event) => {
              type = event.currentTarget.value;
            }, false);

            document.removeEventListener('click', releaseAutoplayPolicy, false);
          };

          document.addEventListener('click', releaseAutoplayPolicy, false);
        })
        .catch(console.error)
    </script>
  </body>
</html>
