<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Noise Suppressor | Audio Signal Processing by WebAssembly</title>
    <link rel="stylesheet" href="../app.css" />
  </head>
  <body>
    <section>
      <nav><a href="../">TOP</a> &gt; &gt; Noise Suppressor</nav>
      <span id="show-status">Click anywhere on this page</span>
      <dt aria-disabled="true">
        <dt><label for="range-threshold">Threshold: <span id="output-threshold">0</span></label></dt>
        <dd><input type="range" id="range-threshold" disabled value="0" min="0" max="1" step="0.05" /></dd>
      </dt>
    </section>
    <script src="./noisesuppressor.js"></script>
    <script>
      const audiocontext = new AudioContext();
      const processor    = audiocontext.createScriptProcessor(0, 2, 2);

      const statusText = document.getElementById('show-status');

      let threshold = 0;

      function startStream(mediaStream) {
        document.getElementById('show-status').textContent = 'onRuntimeInitialized';
        document.querySelector('[aria-disabled]').removeAttribute('aria-disabled');
        document.querySelector('[disabled]').removeAttribute('disabled');

        const noisesuppressor = Module.cwrap('noisesuppressor', null, ['number', 'Float32Array', 'Float32Array', 'number']);

        const source = audiocontext.createMediaStreamSource(mediaStream);

        source.connect(processor);
        processor.connect(audiocontext.destination);

        const bufferSize = processor.bufferSize;

        processor.onaudioprocess = (event) => {
          const inputLs  = event.inputBuffer.getChannelData(0);
          const inputRs  = event.inputBuffer.getChannelData(1);
          const outputLs = event.outputBuffer.getChannelData(0);
          const outputRs = event.outputBuffer.getChannelData(1);

          const pointerInputL  = Module._malloc(bufferSize * Module.HEAPF32.BYTES_PER_ELEMENT);
          const pointerInputR  = Module._malloc(bufferSize * Module.HEAPF32.BYTES_PER_ELEMENT);
          const pointerOutputL = Module._malloc(bufferSize * Module.HEAPF32.BYTES_PER_ELEMENT);
          const pointerOutputR = Module._malloc(bufferSize * Module.HEAPF32.BYTES_PER_ELEMENT);

          const tmpLs = new Float32Array(Module.HEAPF32.buffer, pointerOutputL, bufferSize);
          const tmpRs = new Float32Array(Module.HEAPF32.buffer, pointerOutputR, bufferSize);

          Module.HEAPF32.set(inputLs, pointerInputL / Module.HEAPF32.BYTES_PER_ELEMENT);
          Module.HEAPF32.set(inputRs, pointerInputR / Module.HEAPF32.BYTES_PER_ELEMENT);
          Module.HEAPF32.set(tmpLs,   pointerOutputL / Module.HEAPF32.BYTES_PER_ELEMENT);
          Module.HEAPF32.set(tmpRs,   pointerOutputR / Module.HEAPF32.BYTES_PER_ELEMENT);

          noisesuppressor(threshold, pointerInputL, pointerOutputL, bufferSize);
          noisesuppressor(threshold, pointerInputR, pointerOutputR, bufferSize);

          outputLs.set(tmpLs);
          outputRs.set(tmpRs);

          Module._free(pointerInputL);
          Module._free(pointerInputR);
          Module._free(pointerOutputL);
          Module._free(pointerOutputR);
        };
      }

      function setup() {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(async (mediaStream) => {
            await audiocontext.resume();

            statusText.textContent = 'Loading WASM ...';

            startStream(mediaStream);

            document.removeEventListener('click', setup, false);
          })
          .catch(console.error);

        document.getElementById('range-threshold').addEventListener('input', (event) => {
          const range = event.currentTarget;

          threshold = range.valueAsNumber;
          document.getElementById('output-threshold').textContent = range.value;
        }, false);
      }

      document.addEventListener('click', setup, false);
    </script>
  </body>
</html>
