<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SIMD (Single Instruction Multiple Data) | Audio Signal Processing by WebAssembly</title>
    <link rel="stylesheet" href="../app.css" />
  </head>
  <body>
    <section>
      <nav><a href="../../">TOP</a> &gt;&gt; SIMD</nav>
      <dl>
        <dt><label for="select-data-size">Select Data size</label></dt>
        <dd>
          <select id="select-data-size">
            <option value="128" selected>128 (0x80)</option>
            <option value="256">256</option>
            <option value="512">512</option>
            <option value="1024">1024</option>
            <option value="2048">2048</option>
            <option value="4096">4096</option>
            <option value="8192">8192</option>
            <option value="16384">16384</option>
            <option value="32768">32768 (0x8000)</option>
            <option value="65536">65536 (0xFFFF + 1)</option>
            <option value="131072">131072</option>
            <option value="262144">262144</option>
            <option value="524288">524288</option>
            <option value="1048576">1048576</option>
            <option value="2097152">2097152</option>
            <option value="4194304">4194304</option>
          </select>
        </dd>
      </dl>
      <dl>
        <dt>start time</dt>
        <dd id="print-start-time">0 msec</dd>
        <dt>end time</dt>
        <dd id="print-end-time">0 msec</dd>
        <dt>process time</dt>
        <dd id="print-process-time">0 msec</dd>
      </dl>
    </section>
    <script>
      WebAssembly.instantiateStreaming(fetch('./SIMD.wasm'))
        .then(({ instance }) => {
          const printStartTimeElement   = document.getElementById('print-start-time');
          const printEndTimeElement     = document.getElementById('print-end-time');
          const printProcessTimeElement = document.getElementById('print-process-time');

          const wasm = instance.exports;

          document.getElementById('select-data-size').addEventListener('change', (event) => {
            printStartTimeElement.textContent   = '0 msec';
            printEndTimeElement.textContent     = '0 msec';
            printProcessTimeElement.textContent = '0 msec';

            const size = Number(event.currentTarget.value);

            const inputs = new Float32Array(size);

            inputs.fill(1.0);

            const startTime = performance.now();

            console.time(`Data size is ${size}`);

            const linearMemory = wasm.memory.buffer;

            const offset = wasm.alloc_memory_inputs(size);

            const inputsLinearMemory = new Float32Array(linearMemory, offset, size);

            inputsLinearMemory.set(inputs);

            const result = wasm.SIMD(size);

            console.log(`result is ${result}`);

            console.timeEnd(`Data size is ${size}`);

            const endTime = performance.now();

            const processTime = endTime - startTime;

            printStartTimeElement.textContent   = `${startTime} msec`;
            printEndTimeElement.textContent     = `${endTime} msec`;
            printProcessTimeElement.textContent = `${processTime} msec (${processTime * 1000} Î¼sec)`;
          });
        })
        .catch(console.error);
    </script>
  </body>
</html>
